name: Build Companion ARM64

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout companion
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.21.1'
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libudev-dev libusb-1.0-0-dev
        
    - name: Enable corepack
      run: corepack enable
    
    - name: Check for .yarnrc.yml and modify if needed
      run: |
        if [ -f .yarnrc.yml ]; then
          echo "Found .yarnrc.yml, removing immutable setting..."
          sed -i '/enableImmutableInstalls/d' .yarnrc.yml
          cat .yarnrc.yml
        fi
    
    - name: Remove lockfile to allow regeneration
      run: rm -f yarn.lock
        
    - name: Install dependencies
      run: yarn install --no-immutable
      env:
        SKIP_POSTINSTALL: '1'
        HUSKY: '0'
    
    - name: Patch Stream Deck package to add Discord Edition support
      run: |
        echo "Patching @elgato-stream-deck/node for Discord Edition..."
        CORE_FILE="node_modules/@elgato-stream-deck/core/dist/device-plugins.js"
        if [ -f "$CORE_FILE" ]; then
          sed -i 's/productIds: \[0x0063, 0x0090\]/productIds: [0x0063, 0x0090, 0x00b3]/g' "$CORE_FILE"
          echo "Patched successfully!"
          grep -n "0x00b3" "$CORE_FILE" || echo "Patch verification: 0x00b3 not found"
        else
          echo "Core file not found at $CORE_FILE"
          find node_modules/@elgato-stream-deck -name "*.js" | head -10
        fi
        
    - name: Build Companion for ARM64
      run: |
        sed -i 's/await \$`\${nodeRuntimePath} \${mainJsPath} check-launches\`/console.log("Skipping launch check for cross-compile")/g' tools/build/package.mts
        yarn dist linux-arm64 || echo "Build may have failed at launch check, but files should exist"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CI: true
        
    - name: Find and list built packages
      if: always()
      run: |
        echo "Searching for built packages..."
        echo "=== Looking in electron-output ==="
        find electron-output -type f 2>/dev/null || echo "electron-output not found"
        echo ""
        echo "=== Looking everywhere for companion packages ==="
        find . -name "companion-*.tar.gz" -o -name "companion-*.deb" -o -name "*.AppImage" 2>/dev/null || echo "No packages found"
        
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: companion-linux-arm64
        path: |
          electron-output/**/*
          **/companion-*.tar.gz
          **/companion-*.deb
          **/*.AppImage
        retention-days: 30
        if-no-files-found: warn
