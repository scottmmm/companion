name: Build Companion ARM64

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout companion
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.21.1'
        
    - name: Enable corepack
      run: corepack enable
    
    - name: Check for .yarnrc.yml and modify if needed
      run: |
        if [ -f .yarnrc.yml ]; then
          echo "Found .yarnrc.yml, removing immutable setting..."
          sed -i '/enableImmutableInstalls/d' .yarnrc.yml
          cat .yarnrc.yml
        fi
    
    - name: Remove lockfile to allow regeneration
      run: rm -f yarn.lock
        
    - name: Install dependencies
      run: yarn install --no-immutable
      
    - name: Build Companion for ARM64
      run: yarn dist linux-arm64
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CI: true
        
    - name: List built files
      run: |
        echo "Searching for built packages..."
        find . -type f \( -name "*.AppImage" -o -name "*.deb" -o -name "*.tar.gz" \) 2>/dev/null || echo "No packages found"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: companion-linux-arm64
        path: |
          dist/**/*.AppImage
          dist/**/*.deb
          dist/**/*.tar.gz
          electron-output/**/*.AppImage
          electron-output/**/*.deb
          electron-output/**/*.tar.gz
        retention-days: 30
        if-no-files-found: warn
